# ak si zobrazime cez ls -alt vsetky subory a vidime, ze 
# ma nejaky subor privlastok napr -rwsr-xr-x 1 root root
# tak vieme povedat, ze prebieha setuid za usera root
#

# napr
whereis sudo
ls -alt /usr/bin/sudo

#
# ma tiez prava -rwsr-xr-x 2 root root (has setuid bit)
# setuid can be pretty dangerous, escalate privileges, gain root
# rooting on Android, jailbreaking on iOS

# -- but on real devices its fucking difficult, more layers,
# -- like ogre Shrek, similiar to onions, you see them, you cry

# using gdb for debuging this process, gets you from root to user
# so this is not the way how to exploit things
#
# From school assignment BIT 4.2 valuable info (IN SLOVAK ONLY sorry :)
{
	Program ex5-stack-overflow-3 je privilegovaný. Preto ho hackujeme. Je spravený tak, že po spustení nebeží "pod vami", ale s právami usera flag01. Toto má ten proces nastavené v takzvanom efektívnom UID (euid). Každý proces má aj reálne UID (uid), ktoré sa nepoužíva prakticky na nič, a v ňom je v okamihu spustenia ex5-stack-overflow-3 stále nastavené Vaše user id.Keby shellkód z msfvenom spustil ľubovoľný normálny príkaz, tak ten by bežal pod userom flag01 a dostal by sa do adresára s flagom (želaný stav, všetci happy).Ale drobná chybička msfvenomu je, že ešte aj keď použijete payload linux/x86/exec, ktorý podľa mena vyzerá, že má len vykonať, čo si poviete, on miesto priameho vykonania finálneho príkazu spustí čo ste zadali nepriamo, konkrétne cez /bin/sh. A zároveň shell /bin/sh má tú nepríjemnú vlastnosť, že hneď na začiatku svojho behu spraví seteuid(getuid()), čím vaše privilegované práva spláchne. Všetko, čo sa ďalej z neho spustí, beží už len pod vašimi nudnými právami.Dá sa o tom presvedčiť ako cez strace, tak aj tým, že si jednoducho cez linux/x86/exec dáte spustiť /usr/bin/id. Zobrazí len vaše user id.Ako z toho von?Pred akýkoľvek payload, ktorý vygeneruje msfvenom, si pridajte týchto pár bajtov:

	echo -ne "\x6a\x6b\x58\x0f\x05\x48\x89\xc7\x48\x89\xc6\x48\x89\xc2\x6a\x75\x58\x0f\x05" > setresuid.bin

	Tie inštrukcie robia len to, že zoberú hodnotu z euid a nacpú ju aj do uid, čiže setuid(geteuid()). Potom si už shell môže robiť seteuid(getuid()) koľko chce.

	msfvenom ...parametre... -o payload.bin
	cat setresuid.bin payload.bin > payload2.bin

	Potom používajte payload2.bin pri exploitácii.
}
#